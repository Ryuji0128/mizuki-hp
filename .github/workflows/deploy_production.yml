name: Deploy_Production

on:
  pull_request:
    branches:
      - main
    types: [closed]
  workflow_dispatch:

jobs:
  deploy:
    # develop â†’ main ã®ãƒãƒ¼ã‚¸æ™‚ã®ã¿å®Ÿè¡Œ
    if: github.event.pull_request.base.ref == 'main' && github.event.pull_request.head.ref == 'develop'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_SECRET_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            echo "ğŸš€ Deploying Mizuki Clinic HP..."

            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•
            cd ~/mizuki-hp

            # Git æ›´æ–°
            echo "ğŸŒ€ Pulling latest code from main..."
            git fetch origin main
            git reset --hard origin/main

            # ä¾å­˜é–¢ä¿‚æ›´æ–°
            echo "ğŸ“¦ Installing dependencies..."
            yarn install --frozen-lockfile

            # DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ãªã‚‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã‹ã‚‰ï¼‰
            echo "ğŸ§© Running Prisma migrations..."
            npx prisma migrate deploy

            # Next.js ãƒ“ãƒ«ãƒ‰
            echo "ğŸ— Building Next.js app..."
            NODE_ENV=production yarn build

            # PM2 å†èµ·å‹•ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã° startï¼‰
            echo "ğŸ” Restarting application with PM2..."
            if pm2 list | grep -q "mizuki-hp"; then
              pm2 reload mizuki-hp --update-env
            else
              pm2 start "yarn start" --name mizuki-hp
            fi

            # PM2æ°¸ç¶šåŒ–ï¼ˆå†èµ·å‹•å¯¾ç­–ï¼‰
            pm2 save

            echo "âœ… Deployment completed successfully!"
